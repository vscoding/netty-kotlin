name: Delete old workflow runs

on:
  push:
    branches: [ main ]
  schedule:
    # 每天 19:00 UTC（北京时间 03:00）
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      retain_days:
        description: "Retain workflow runs for N days"
        required: false
        default: "7"
      keep_minimum_runs:
        description: "Keep at least N runs"
        required: false
        default: "6"

# 仅当本次 run 会真正执行迁移时，才启用并发互斥（否则不需要占用并发组）
concurrency:
  group: >-
    delete-workflow-runs-${{ github.ref }}-${{
      github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '#ci:ops:cleanup:runs')
        && 'active'
        || 'inactive'
    }}
  # 只有“会执行迁移”的 run 才取消旧的 in-progress run
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '#ci:ops:cleanup:runs') }}


jobs:
  del_runs:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '#ci:ops:cleanup:runs')
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete workflow runs for current repo
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets._GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: ${{ inputs.retain_days || 7 }}
          keep_minimum_runs: ${{ inputs.keep_minimum_runs || 6 }}
