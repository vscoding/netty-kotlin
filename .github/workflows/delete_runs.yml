name: Delete old workflow runs

on:
  push:
    branches: [ main ]
  schedule:
    # 每天 19:00 UTC（北京时间 03:00）
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      retain_days:
        description: "Retain workflow runs for N days"
        required: false
        default: "7"
      keep_minimum_runs:
        description: "Keep at least N runs"
        required: false
        default: "6"

concurrency:
  group: >-
    delete-runs-${{ github.repository }}-${{
      (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || contains(github.event.head_commit.message, '#ci:ops:cleanup:runs'))
        && 'active'
        || 'inactive'
    }}
  # 仅当本次 run 会真正执行删除时，才取消同组在途运行
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || contains(github.event.head_commit.message, '#ci:ops:cleanup:runs') }}

jobs:
  del_runs:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '#ci:ops:cleanup:runs')
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete workflow runs for current repo
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: ${{ inputs.retain_days || 7 }}
          keep_minimum_runs: ${{ inputs.keep_minimum_runs || 6 }}